<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>杉田接骨院 予約変更・キャンセル</title>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    /* 右端の細いナビ（固定） */
    .side-nav{position:fixed;right:-5px;top:80%;transform:translateY(-50%) translateX(13px);background:#13ca5e;display:flex;flex-direction:column;align-items:center;padding:4px;border-radius:10px 0 0 10px;z-index:1000;width:35px}
    .side-nav a{display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;text-decoration:none;font-size:10px;margin:5px 0;padding:5px;border-radius:5px;width:30px;height:30px;text-align:center}
    .side-nav a span{font-size:24px;position:absolute;left:0;top:13px}
    @media (max-width:600px){.side-nav{right:2px;width:30px}.side-nav a{width:28px;height:28px}.side-nav a i{font-size:12px}}

    /* ベース */
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Hiragino Kaku Gothic ProN","Noto Sans JP","Meiryo",sans-serif;background:#e7e7e7;display:flex;justify-content:center;align-items:flex-start;margin:0;padding:10px}
    .container{background:#fff;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08);width:92%;max-width:520px;padding:22px;box-sizing:border-box;margin:0 auto}
    h1{background:linear-gradient(135deg,#13ca5e,#0fa958);color:#fff;padding:20px;border-radius:0 15px 0 45px;text-align:center;display:block;margin:-20px -15px 20px -15px;font-size:26px;font-weight:700;box-shadow:inset 0 -5px 10px rgba(0,0,0,.05)}

    .label{display:flex;justify-content:space-between;align-items:center;margin:14px 0 6px;background:#13ca5e;color:#fff;border-radius:6px;font-weight:700;font-size:16px;padding:8px 10px}
    .required{background:#ff2d2d;color:#fff;border-radius:4px;padding:1px 6px;margin-left:8px;font-size:11px}
    .optional{background:#6c757d;color:#fff;border-radius:4px;padding:1px 6px;margin-left:8px;font-size:11px}

    input[type="text"],textarea,input[type="date"],select{
      width:100%;padding:12px;border:1.5px solid #dcdcdc;border-radius:8px;box-sizing:border-box;font-size:16px;background:#fff;transition:border-color .2s,box-shadow .2s
    }
    input:focus,textarea:focus,select:focus{outline:none;border-color:#13ca5e;box-shadow:0 0 0 3px rgba(19,202,94,.15)}
    textarea{min-height:110px;resize:vertical}

    /* 希望日時：縦並び */
    .dt-group{margin-top:8px;margin-bottom:10px}
    .sub-label{font-size:13px;font-weight:700;color:#333;margin:4px 0 6px;display:inline-flex;align-items:center;gap:8px;background:#f1fff6;border:1px solid #bfead1;border-radius:6px;padding:4px 8px}

    /* 日付＋時間を横並び */
    .dt-inline{display:flex;gap:8px}
    .dt-inline .date-input{flex:2}
    .dt-inline .time-input{flex:1}

    .note{margin-top:10px;font-size:12px;color:#666;line-height:1.6}
    .submit{width:100%;padding:14px;border:none;border-radius:10px;background:#dc3545;color:#fff;font-size:18px;font-weight:700;cursor:pointer}
    .submit:active{transform:scale(.99)}
  </style>
</head>
<body>
  <!-- 右側ナビ（任意） -->
  <div class="side-nav" id="sideNav">
    <a href="#section-submit" aria-label="送信へ"><span>⇩</span><i class="fas fa-paper-plane"></i></a>
  </div>

  <div class="container">
    <h1>杉田接骨院 予約変更・キャンセル</h1>

    <!-- ① お名前（必須） -->
    <div class="label">お名前 <span class="required">必須</span></div>
    <input type="text" id="name" placeholder="例：山田 太郎" autocomplete="name" />

    <!-- ② 現在の予約日時（自由記載・必須） -->
    <div class="label">現在の予約日時 <span class="required">必須</span></div>
    <input type="text" id="current" placeholder="例：2025年10月30日 14:00（60分）" />

    <!-- ③ 変更希望日時（第1〜第3：第1は必須／第2・第3は任意） -->
    <div class="label">変更希望日時（第1〜第3） <span class="required">第1は必須・第2/第3は任意</span></div>

    <div class="dt-group">
      <div class="sub-label">第1希望 <span class="required">必須</span></div>
      <div class="dt-inline">
        <input type="date" id="date1Date" class="date-input" aria-label="第1希望日付" />
        <select id="date1Time" class="time-input" aria-label="第1希望時間"></select>
      </div>
    </div>
    <div class="dt-group">
      <div class="sub-label">第2希望 <span class="optional">任意</span></div>
      <div class="dt-inline">
        <input type="date" id="date2Date" class="date-input" aria-label="第2希望日付（任意）" />
        <select id="date2Time" class="time-input" aria-label="第2希望時間（任意）"></select>
      </div>
    </div>
    <div class="dt-group">
      <div class="sub-label">第3希望 <span class="optional">任意</span></div>
      <div class="dt-inline">
        <input type="date" id="date3Date" class="date-input" aria-label="第3希望日付（任意）" />
        <select id="date3Time" class="time-input" aria-label="第3希望時間（任意）"></select>
      </div>
    </div>

    <!-- ④ 備考（任意） -->
    <div class="label">備考</div>
    <textarea id="note" placeholder="連絡希望時間、注意点などがあればご記入ください"></textarea>

    <button id="section-submit" class="submit" onclick="submitForm()">送信する</button>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script>
    // 必要に応じて差し替え
    const LIFF_ID = "2008384607-3G86VGrn";

    // 入力保存（name/current/note）
    function saveInput(id){
      const el=document.getElementById(id);
      if(el) localStorage.setItem(id, el.value);
    }
    ["name","current","note"].forEach(id=>{
      document.addEventListener("input",(e)=>{ if(e.target && e.target.id===id) saveInput(id); });
    });

    // 時間プルダウン生成（9:00〜20:30 / 30分刻み）
    function populateTimeSelect(id){
      const sel = document.getElementById(id);
      if(!sel) return;
      sel.innerHTML = "";

      const optEmpty = document.createElement("option");
      optEmpty.value = "";
      optEmpty.textContent = "選択してください";
      sel.appendChild(optEmpty);

      for(let h = 9; h <= 20; h++){
        for(let m of [0,30]){
          const hh = String(h).padStart(2,"0");
          const mm = String(m).padStart(2,"0");
          const value = `${hh}:${mm}`;
          const label = `${h}:${mm}`; // 表示 9:00 形式

          const opt = document.createElement("option");
          opt.value = value;
          opt.textContent = label;
          sel.appendChild(opt);

          // 20:30 になったら終了
          if(h === 20 && m === 30) break;
        }
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try { await liff.init({ liffId: LIFF_ID }); }
      catch (e) { console.error("LIFF初期化に失敗:", e); }

      // 前回値の復元
      ["name","current","note"].forEach(id=>{
        const v = localStorage.getItem(id);
        if(v) document.getElementById(id).value = v;
      });

      // 日付は本日以降のみ
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm   = String(today.getMonth()+1).padStart(2,"0");
      const dd   = String(today.getDate()).padStart(2,"0");
      const todayStr = `${yyyy}-${mm}-${dd}`;
      ["date1Date","date2Date","date3Date"].forEach(id => {
        const el=document.getElementById(id);
        if(el) el.min = todayStr;
      });

      // 時間プルダウン生成
      ["date1Time","date2Time","date3Time"].forEach(populateTimeSelect);
    });

    // 日付＋時間のフォーマット
    function formatJP(dateStr, timeStr){
      if(!dateStr || !timeStr) return "";
      const parts = dateStr.split("-");
      if(parts.length !== 3) return "";
      const y = parts[0];
      const m = String(Number(parts[1]));
      const d = String(Number(parts[2]));
      const [hh, mm] = timeStr.split(":");
      const hDisp = String(Number(hh)); // 09 → 9
      return `${y}年${m}月${d}日 ${hDisp}:${mm}`;
    }

    function submitForm(){
      const name  = document.getElementById("name").value.trim();
      const curr  = document.getElementById("current").value.trim();

      const date1Date = document.getElementById("date1Date").value;
      const date1Time = document.getElementById("date1Time").value;
      const date2Date = document.getElementById("date2Date").value;
      const date2Time = document.getElementById("date2Time").value;
      const date3Date = document.getElementById("date3Date").value;
      const date3Time = document.getElementById("date3Time").value;

      const note  = document.getElementById("note").value.trim();

      // 必須チェック（第1のみ必須：日付＋時間）
      if(!name){ alert("お名前をご入力ください。"); return; }
      if(!curr){ alert("現在の予約日時をご入力ください。"); return; }
      if(!date1Date || !date1Time){
        alert("変更希望日時は第1希望の「日付」と「時間」をご入力／選択ください。第2・第3は任意です。");
        return;
      }

      const message =
`【杉田接骨院予約変更・キャンセル】
お名前：${name}

現在の予約日時：${curr}

【変更希望日時】
・第1希望：${formatJP(date1Date, date1Time)}
・第2希望：${formatJP(date2Date, date2Time) || "（未入力）"}
・第3希望：${formatJP(date3Date, date3Time) || "（未入力）"}

備考：${note || "（なし）"}`;

      liff.sendMessages([{ type:"text", text: message }])
        .then(() => {
          alert("送信が完了しました。ご連絡をお待ちください。");
          liff.closeWindow();
        })
        .catch(err => {
          console.error("送信失敗:", err);
          alert("送信に失敗しました。電波状況をご確認のうえ、再度お試しください。");
        });
    }
  </script>
</body>
</html>
